<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×”××™×¨×•×¥ ×œ××™×œ×™×•×Ÿ â€“ ×× ×”×œ + ×”×¦×˜×¨×¤×•×ª ×§×‘×•×¦×•×ª</title>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#f6f6f7; --card:#fff; --ink:#111; --muted:rgba(0,0,0,.6);
      --line:rgba(0,0,0,.12); --soft:rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .container{max-width:980px;margin:0 auto;padding:18px}
    .top{display:flex;gap:12px;justify-content:space-between;align-items:flex-end;flex-wrap:wrap;margin-bottom:14px}
    .title{font-size:22px;font-weight:800}
    .subtitle{font-size:13px;color:var(--muted);margin-top:4px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;background:var(--soft);font-size:12px;font-weight:700}
    .nav{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    .card + .card{margin-top:12px}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){.row{grid-template-columns:1fr 1fr}}
    label{display:block;font-size:13px;font-weight:700;margin:10px 0 6px}
    input,textarea{width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);font-size:14px;background:#fff}
    textarea{min-height:92px;resize:vertical}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
    button{border:none;border-radius:14px;padding:10px 12px;font-weight:800;cursor:pointer;font-size:13px}
    .primary{background:#111;color:#fff}
    .secondary{background:var(--soft);color:#111}
    .ghost{background:transparent;color:#111;border:1px solid var(--line)}
    button:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;border-radius:14px;border:1px solid var(--line);overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:right;vertical-align:top;font-size:13px}
    th{background:var(--soft);font-weight:800;font-size:12px}
    tr:hover td{background:rgba(0,0,0,.02)}
    .small{font-size:12px;color:var(--muted);margin-top:4px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;direction:ltr;text-align:left;word-break:break-all}
    .progressWrap{margin-top:6px;height:8px;background:rgba(0,0,0,.08);border-radius:999px;overflow:hidden}
    .progressBar{height:100%;background:#111;width:0}
  </style>
</head>

<body>
  <div class="container">
    <div class="top">
      <div>
        <div class="title">×”××™×¨×•×¥ ×œ××™×œ×™×•×Ÿ â€“ ××¡×‘×™×‘ ×œ×¢×•×œ×</div>
        <div class="subtitle">index.html ××—×“ Â· ×× ×”×œ + ×”×¦×˜×¨×¤×•×ª Â· Firebase</div>
      </div>
      <div class="chips">
        <span class="chip">8 ×ª×—× ×•×ª</span>
        <span class="chip">×¡×™×•×: ×™×©×¨××œ</span>
      </div>
    </div>

    <div class="nav">
      <button class="secondary" id="btnHome">×‘×™×ª</button>
      <button class="secondary" id="btnAdmin">×¨×›×–/×ª</button>
      <button class="secondary" id="btnJoin">××©×ª×ª×¤×™×</button>
    </div>

    <div id="app"></div>
  </div>

<script>
  // ===== 1) Firebase config (×›××• ×©×”×‘××ª) =====
  const firebaseConfig = {
    apiKey: "AIzaSyC1iJ8K0cXJR3ln-HTqSb0LYcaFmA0Lvi4",
    authDomain: "million-race.firebaseapp.com",
    projectId: "million-race",
    storageBucket: "million-race.firebasestorage.app",
    messagingSenderId: "74064106162",
    appId: "1:74064106162:web:22665f46bd39614d0cefab",
    measurementId: "G-WD1XLMFSMC"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ×ª×—× ×•×ª (×‘×œ×™ ××¨×›××•×ª ×‘×¢×™×™×ª×™×•×ª)
  const STATIONS = ["××¦×¨×™×","×”×•×“×•","×™×¤×Ÿ","×××¨×™×§×”","×¡×¤×¨×“","××¤×¨×™×§×”","××•×¡×˜×¨×œ×™×”","×™×©×¨××œ"];
  const FINAL_STATION = "×™×©×¨××œ";

  // ===== utils =====
  function $(id){ return document.getElementById(id); }
  function esc(s){
    return (s ?? "").toString()
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }
  function clamp(s,max){
    const t = (s ?? "").toString().trim();
    return t.length>max ? t.slice(0,max) : t;
  }
  function now(){ return Date.now(); }
  function formatTime(ts){ try{return new Date(ts).toLocaleString();}catch(e){return "";} }

  function makeGameId(){
    const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let out="";
    for(let i=0;i<6;i++) out += chars[Math.floor(Math.random()*chars.length)];
    return out;
  }
  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      const t=a[i]; a[i]=a[j]; a[j]=t;
    }
    return a;
  }
  function buildRoute(){
    const mid = STATIONS.filter(s => s !== FINAL_STATION);
    const r = shuffle(mid);
    r.push(FINAL_STATION);
    return r;
  }
  function parseHash(){
    const h = window.location.hash || "#/";
    const clean = h.startsWith("#") ? h.slice(1) : h;
    const parts = clean.split("?");
    const path = parts[0] || "/";
    const qs = parts[1] || "";
    return { path, params: new URLSearchParams(qs) };
  }
  function goto(hash){ window.location.hash = hash; }

  let unsub = null;
  function cleanupListener(){
    try{ if(typeof unsub === "function") unsub(); } catch(e){}
    unsub=null;
  }

  async function ensureAnonAuth(){
    if(auth.currentUser) return;
    try{
      await auth.signInAnonymously();
    }catch(e){
      console.error(e);
      alert("×©×’×™××ª ×”×ª×—×‘×¨×•×ª ×× ×•× ×™××™×ª. ×‘×“×§×™: Firebase â†’ Authentication â†’ Sign-in method â†’ Anonymous = Enabled");
    }
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      alert("×”×•×¢×ª×§ âœ…");
    }catch(e){
      prompt("×”×¢×ª×§×” ×™×“× ×™×ª (Ctrl+C)", text);
    }
  }

  function setNavActive(which){
    const map = { home:"btnHome", admin:"btnAdmin", join:"btnJoin" };
    ["btnHome","btnAdmin","btnJoin"].forEach(id=>{
      const el=$(id); if(!el) return;
      el.classList.remove("primary"); el.classList.add("secondary");
    });
    const active=$(map[which] || "btnHome");
    if(active){ active.classList.remove("secondary"); active.classList.add("primary"); }
  }

  // ===== screens =====
  function renderHome(){
    cleanupListener(); setNavActive("home");
    $("app").innerHTML =
      '<div class="row">'
    + ' <div class="card"><h3>×¨×›×–/×ª</h3><p>×™×¦×™×¨×ª ××©×—×§, ×§×•×“/×§×™×©×•×¨, ×•× ×™×˜×•×¨ ×”×ª×§×“××•×ª.</p>'
    + ' <div class="actions"><button class="primary" id="goAdmin">×”×ª×—×œ / × ×™×”×•×œ ××©×—×§</button></div></div>'
    + ' <div class="card"><h3>××©×ª×ª×¤×™×</h3><p>×”×¦×˜×¨×¤×•×ª ×¢× ×§×•×“ ××©×—×§: ×©× ×§×‘×•×¦×” + ×©××•×ª ×—×‘×¨×™×.</p>'
    + ' <div class="actions"><button class="primary" id="goJoin">×”×¦×˜×¨×¤×•×ª ×œ×§×‘×•×¦×”</button></div></div>'
    + '</div>';
    $("goAdmin").onclick=()=>goto("#/admin");
    $("goJoin").onclick=()=>goto("#/join");
  }

  function renderAdmin(){
    cleanupListener(); setNavActive("admin");
    $("app").innerHTML =
      '<div class="card">'
    + ' <h3>×¨×›×–/×ª â€“ ×™×¦×™×¨×ª ××©×—×§ / ×˜×¢×™× ×ª ××©×—×§</h3>'
    + ' <p class="small">××—×¨×™ ×™×¦×™×¨×ª ××©×—×§ ×ª×§×‘×œ×™ ×§×•×“ ×•×§×™×©×•×¨ ×œ×©×œ×™×—×” ×œ×§×‘×•×¦×•×ª.</p>'
    + ' <div class="row" style="margin-top:12px;">'
    + '  <div class="card" style="margin:0;">'
    + '   <h3 style="font-size:14px;">×™×¦×™×¨×ª ××©×—×§ ×—×“×©</h3>'
    + '   <label>×©× ×¨×›×–/×ª (××•×¤×¦×™×•× ×œ×™)</label><input id="adminName" placeholder="×œ×“×•×’××”: ×™×¢×œ" />'
    + '   <div class="actions"><button class="primary" id="btnCreate">×”×ª×—×œ ××©×—×§</button></div>'
    + '  </div>'
    + '  <div class="card" style="margin:0;">'
    + '   <h3 style="font-size:14px;">×˜×¢×™× ×ª ××©×—×§ ×§×™×™×</h3>'
    + '   <label>×§×•×“ ××©×—×§</label><input id="loadGameId" placeholder="×œ×“×•×’××”: Q7K2MP" />'
    + '   <div class="actions"><button class="secondary" id="btnLoad">×˜×¢×Ÿ</button></div>'
    + '  </div>'
    + ' </div>'
    + '</div>';

    $("btnCreate").onclick = async ()=>{
      await ensureAnonAuth();
      const adminName = clamp($("adminName").value,40) || "×¨×›×–/×ª";
      const gameId = makeGameId();
      await db.collection("games").doc(gameId).set({
        gameId, adminName, createdAt: now(),
        createdAtServer: firebase.firestore.FieldValue.serverTimestamp()
      });
      goto("#/admin-game?game="+encodeURIComponent(gameId));
    };

    $("btnLoad").onclick = async ()=>{
      await ensureAnonAuth();
      const gameId = clamp($("loadGameId").value,16).toUpperCase();
      if(!gameId) return;
      const snap = await db.collection("games").doc(gameId).get();
      if(!snap.exists) return alert("×œ× × ××¦× ××©×—×§ ×‘×§×•×“ ×”×–×”.");
      goto("#/admin-game?game="+encodeURIComponent(gameId));
    };
  }

  function renderAdminGame(gameId){
    setNavActive("admin");
    const base = window.location.origin + window.location.pathname;
    const joinLink = base + "#/join?game=" + encodeURIComponent(gameId);

    $("app").innerHTML =
      '<div class="card">'
    + ' <h3>× ×™×”×•×œ ××©×—×§</h3>'
    + ' <p>×§×•×“: <b>'+esc(gameId)+'</b></p>'
    + ' <div class="actions">'
    + '   <button class="secondary" id="copyCode">×”×¢×ª×§ ×§×•×“</button>'
    + '   <button class="primary" id="copyLink">×”×¢×ª×§ ×§×™×©×•×¨</button>'
    + ' </div>'
    + ' <div class="mono" style="margin-top:8px;">'+esc(joinLink)+'</div>'
    + ' <div style="margin-top:14px;">'
    + '  <table><thead><tr><th style="width:160px;">×§×‘×•×¦×”</th><th>×—×‘×¨×™×</th><th style="width:200px;">×”×ª×§×“××•×ª</th></tr></thead>'
    + '   <tbody id="teamsBody"><tr><td colspan="3" class="small">×˜×•×¢×Ÿ...</td></tr></tbody>'
    + '  </table>'
    + ' </div>'
    + ' <div class="actions" style="margin-top:10px;"><button class="ghost" id="backAdmin">×—×–×¨×”</button></div>'
    + '</div>';

    $("copyCode").onclick=()=>copyText(gameId);
    $("copyLink").onclick=()=>copyText(joinLink);
    $("backAdmin").onclick=()=>goto("#/admin");

    cleanupListener();
    unsub = db.collection("games").doc(gameId).collection("teams")
      .orderBy("createdAt","asc")
      .onSnapshot(snap=>{
        const body = $("teamsBody");
        if(snap.empty){
          body.innerHTML = '<tr><td colspan="3" class="small">××™×Ÿ ×¢×“×™×™×Ÿ ×§×‘×•×¦×•×ª. ×©×œ×—×™ ××ª ×”×§×•×“/×§×™×©×•×¨ ×›×“×™ ×©×™×™×¨×©××•.</td></tr>';
          return;
        }
        let html="";
        snap.forEach(docSnap=>{
          const d=docSnap.data()||{};
          const route = Array.isArray(d.route)&&d.route.length ? d.route : STATIONS;
          const completed = d.completed || {};
          const done = route.filter(s=>!!completed[s]).length;
          const pct = Math.round((done/route.length)*100);
          html +=
            '<tr style="cursor:pointer" data-team="'+esc(docSnap.id)+'">'
          + ' <td><b>'+esc(d.name||docSnap.id)+'</b><div class="small">× ×¨×©××”: '+esc(formatTime(d.createdAt||0))+'</div></td>'
          + ' <td class="small" style="white-space:pre-wrap">'+esc(d.members||"â€”")+'</td>'
          + ' <td><div class="small" style="display:flex;justify-content:space-between"><span>'+done+'/'+route.length+'</span><span>'+pct+'%</span></div>'
          + ' <div class="progressWrap"><div class="progressBar" style="width:'+pct+'%"></div></div></td>'
          + '</tr>';
        });
        body.innerHTML = html;
      }, err=>{
        console.error(err);
        alert("×©×’×™××” ×‘×”××–× ×” ×œ×§×‘×•×¦×•×ª. ×‘×“×§×™ Firestore Rules / Authentication.");
      });
  }

  function renderJoin(gameIdMaybe){
    cleanupListener(); setNavActive("join");
    const code = (gameIdMaybe||"").toString().toUpperCase().trim();

    $("app").innerHTML =
      '<div class="card">'
    + ' <h3>××©×ª×ª×¤×™× â€“ ×”×¦×˜×¨×¤×•×ª</h3>'
    + ' <p class="small">×”×›× ×™×¡×• ×§×•×“ ××©×—×§ ××• ×”×™×›× ×¡×• ×“×¨×š ×§×™×©×•×¨ ×©×”×¨×›×–/×ª ×©×œ×—×•.</p>'
    + ' <div class="row" style="margin-top:12px;">'
    + '  <div class="card" style="margin:0;">'
    + '   <label>×§×•×“ ××©×—×§</label><input id="joinGameId" placeholder="×œ×“×•×’××”: Q7K2MP" value="'+esc(code)+'"/>'
    + '  </div>'
    + '  <div class="card" style="margin:0;">'
    + '   <label>×©× ×”×§×‘×•×¦×”</label><input id="teamName" placeholder="×œ×“×•×’××”: ×”×¤× ×ª×¨×™×" />'
    + '   <label>×©××•×ª ×—×‘×¨×™/×•×ª ×”×§×‘×•×¦×”</label><textarea id="members" placeholder="××¤×©×¨ ×‘×©×•×¨×•×ª / ×¤×¡×™×§×™×"></textarea>'
    + '   <div class="actions"><button class="primary" id="submitJoin">×¦××• ×œ×“×¨×š</button></div>'
    + '  </div>'
    + ' </div>'
    + '</div>';

    $("submitJoin").onclick = async ()=>{
      await ensureAnonAuth();
      const gid = clamp($("joinGameId").value,16).toUpperCase();
      const teamName = clamp($("teamName").value,40);
      const members = clamp($("members").value,300);

      if(!gid) return alert("× × ×œ×”×›× ×™×¡ ×§×•×“ ××©×—×§");
      if(!teamName) return alert("× × ×œ××œ× ×©× ×§×‘×•×¦×”");

      const gameSnap = await db.collection("games").doc(gid).get();
      if(!gameSnap.exists) return alert("×”××©×—×§ ×œ× × ××¦×. ×‘×“×§×• ×©×”×§×•×“ × ×›×•×Ÿ.");

      const teamId = "team_" + teamName.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_×-×ª]/g,"");
      const teamRef = db.collection("games").doc(gid).collection("teams").doc(teamId);
      const teamSnap = await teamRef.get();

      if(teamSnap.exists){
        await teamRef.update({
          members,
          updatedAt: now(),
          updatedAtServer: firebase.firestore.FieldValue.serverTimestamp()
        });
      }else{
        await teamRef.set({
          id: teamId,
          name: teamName,
          members,
          route: buildRoute(),
          completed: {},
          createdAt: now(),
          updatedAt: now(),
          createdAtServer: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAtServer: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      alert("×‘×”×¦×œ×—×” ×‘××™×¨×•×¥! ğŸ");
      $("teamName").value="";
      $("members").value="";
    };
  }

  async function render(){
    const {path, params} = parseHash();

    if(path === "/") return renderHome();
    if(path === "/admin") return renderAdmin();

    if(path === "/admin-game"){
      await ensureAnonAuth();
      const gameId = (params.get("game")||"").toUpperCase().trim();
      if(!gameId) return renderAdmin();
      const snap = await db.collection("games").doc(gameId).get();
      if(!snap.exists){ alert("×”××©×—×§ ×œ× × ××¦×"); return renderAdmin(); }
      return renderAdminGame(gameId);
    }

    if(path === "/join"){
      const gid = (params.get("game")||"").toUpperCase().trim();
      return renderJoin(gid);
    }

    return renderHome();
  }

  // nav
  $("btnHome").onclick=()=>goto("#/");
  $("btnAdmin").onclick=()=>goto("#/admin");
  $("btnJoin").onclick=()=>goto("#/join");

  window.addEventListener("hashchange", render);
  window.addEventListener("error", (e)=>{
    console.error(e);
    const msg = (e && e.message) ? e.message : "×©×’×™××” ×œ× ×™×“×•×¢×”";
    $("app").innerHTML =
      '<div class="card"><h3>×©×’×™××ª ×˜×¢×™× ×”</h3>'
    + '<p class="small">×”×“×£ × ×˜×¢×Ÿ ××‘×œ JavaScript × ×ª×§×¢. ×¤×ª×—×™ Console ×•×¦×™×œ××™ ××ª ×”×©×•×¨×” ×”××“×•××” ×”×¨××©×•× ×”.</p>'
    + '<div class="mono">'+esc(msg)+'</div></div>';
  });

  render();
</script>
</body>
</html>

